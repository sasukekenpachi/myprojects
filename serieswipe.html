<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THR: The Ultimate Discovery Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        :root { --thr-gold: #c6a355; }
        body { background: #000; overflow: hidden; position: fixed; width: 100%; font-family: 'Inter', sans-serif; }

        .swiper-container {
            position: relative;
            width: 90vw;
            max-width: 380px;
            height: 75vh;
            max-height: 600px;
            perspective: 1200px;
        }

        .card {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 24px;
            background: #111;
            overflow: hidden;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            border: 1px solid #333;
            transform-origin: 50% 100%;
            touch-action: none;
            z-index: 10;
        }

        .card-img {
            width: 100%; height: 100%;
            object-fit: cover; /* Ensures poster fits perfectly */
            pointer-events: none;
        }

        /* Glass Info Overlay */
        .info-panel {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            padding: 24px 20px 32px;
            background: linear-gradient(to top, rgba(0,0,0,1) 30%, rgba(0,0,0,0.7) 70%, transparent);
            backdrop-filter: blur(8px);
        }

        .badge {
            position: absolute; top: 15%; padding: 10px 24px;
            border: 6px solid; border-radius: 12px;
            font-weight: 900; font-size: 2.5rem; opacity: 0; z-index: 50;
            pointer-events: none;
        }
        .badge-like { border-color: #4ade80; color: #4ade80; left: 20px; transform: rotate(-15deg); }
        .badge-nope { border-color: #f87171; color: #f87171; right: 20px; transform: rotate(15deg); }

        .tag {
            position: absolute; top: 20px; left: 20px;
            background: var(--thr-gold); color: black;
            padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 800; z-index: 20;
        }

        #summary-screen {
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .watchlist-grid::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen text-white">

    <div class="mb-6 text-center">
        <h1 class="text-3xl font-black italic tracking-tighter" style="color: var(--thr-gold)">THR <span class="text-white not-italic font-light">MIXER</span></h1>
        <p class="text-zinc-500 text-[10px] uppercase tracking-[0.4em] mt-1">Personalized discovery</p>
    </div>

    <div id="deck" class="swiper-container">
        <div id="summary-screen" class="hidden absolute inset-0 rounded-[24px] p-6 flex flex-col items-center border border-zinc-800">
            <h2 class="text-xl font-bold mb-4 italic text-yellow-500">YOUR WATCHLIST</h2>
            <div id="watchlist-grid" class="watchlist-grid w-full grid grid-cols-2 gap-3 overflow-y-auto mb-6 flex-grow"></div>
            <button onclick="shareList()" class="w-full bg-white text-black font-black py-4 rounded-2xl active:scale-95 transition mb-3">üì§ SHARE LIST</button>
            <button onclick="resetHistory()" class="text-zinc-600 text-[10px] uppercase tracking-widest underline">Reset Seen History</button>
        </div>
    </div>

    <div id="controls" class="mt-8 flex gap-12">
        <button onclick="uiSwipe(false)" class="w-16 h-16 rounded-full bg-zinc-900 border border-zinc-800 text-red-500 shadow-2xl flex items-center justify-center text-2xl">‚úï</button>
        <button onclick="uiSwipe(true)" class="w-16 h-16 rounded-full bg-zinc-900 border border-zinc-800 text-green-500 shadow-2xl flex items-center justify-center text-2xl">‚ù§</button>
    </div>

    <script>
        const API_KEY = 'cb5d24ec84fde23c28d5627f9fda316a';
        const deck = document.getElementById('deck');
        const grid = document.getElementById('watchlist-grid');
        
        let watchlist = [];
        let totalCards = 0;
        let seenIds = JSON.parse(localStorage.getItem('thr_seen_ids')) || [];

        async function init() {
            const urls = [
                `https://api.themoviedb.org/3/discover/movie?api_key=${API_KEY}&primary_release_date.gte=2026-01-01&primary_release_date.lte=2026-01-31`,
                `https://api.themoviedb.org/3/discover/tv?api_key=${API_KEY}&first_air_date.gte=2026-01-01&first_air_date.lte=2026-01-31`,
                `https://api.themoviedb.org/3/movie/top_rated?api_key=${API_KEY}`
            ];

            try {
                const responses = await Promise.all(urls.map(u => fetch(u).then(r => r.json())));
                let rawList = [...responses[0].results, ...responses[1].results, ...responses[2].results];
                
                // Filter out seen IDs and remove duplicates
                let filtered = [];
                const map = new Map();
                for (const item of rawList) {
                    if (!seenIds.includes(item.id) && !map.has(item.id)) {
                        map.set(item.id, true);
                        filtered.push(item);
                    }
                }

                const finalPool = filtered.sort(() => Math.random() - 0.5).slice(0, 12);
                totalCards = finalPool.length;

                if (totalCards === 0) {
                    deck.innerHTML = `<div class="flex items-center justify-center h-full text-zinc-500 text-center p-10">No new shows found! <br>Check back tomorrow or reset history.</div>`;
                } else {
                    finalPool.forEach(item => createCard(item));
                }
            } catch (e) {
                console.error("Failed to load TMDB", e);
            }
        }

        function createCard(data) {
            const card = document.createElement('div');
            card.className = 'card';
            const title = data.title || data.name;
            const snippet = data.overview ? data.overview.substring(0, 85) + '...' : "No description available.";
            const isMovie = !!data.title;

            card.innerHTML = `
                <div class="badge badge-like">KEEP</div>
                <div class="badge badge-nope">SKIP</div>
                <div class="tag">${isMovie ? 'MOVIE' : 'SERIES'}</div>
                <img src="https://image.tmdb.org/t/p/w500${data.poster_path}" class="card-img">
                <div class="info-panel">
                    <h3 class="font-bold text-xl leading-tight mb-2">${title}</h3>
                    <p class="text-zinc-300 text-xs leading-relaxed">${snippet}</p>
                    <div class="mt-4 flex items-center justify-between">
                         <span class="text-yellow-500 font-bold text-xs">‚òÖ ${data.vote_average.toFixed(1)}</span>
                         <span class="text-zinc-600 text-[10px] tracking-widest">${(data.release_date || data.first_air_date || '2026').split('-')[0]}</span>
                    </div>
                </div>
            `;

            const mc = new Hammer(card);
            mc.get('pan').set({ direction: Hammer.DIRECTION_ALL });

            mc.on('pan', e => {
                if (e.isFinal) {
                    if (Math.abs(e.deltaX) > 140) finalize(card, data, e.deltaX > 0);
                    else reset(card);
                } else {
                    const rot = e.deltaX / 15;
                    card.style.transform = `translate(${e.deltaX}px, ${e.deltaY}px) rotate(${rot}deg)`;
                    card.querySelector('.badge-like').style.opacity = e.deltaX > 50 ? e.deltaX/150 : 0;
                    card.querySelector('.badge-nope').style.opacity = e.deltaX < -50 ? Math.abs(e.deltaX)/150 : 0;
                }
            });
            deck.appendChild(card);
        }

        function finalize(card, data, liked) {
            // Save to Seen History
            seenIds.push(data.id);
            localStorage.setItem('thr_seen_ids', JSON.stringify(seenIds));

            if(liked) {
                watchlist.push(data);
                const div = document.createElement('div');
                div.className = "rounded-xl overflow-hidden h-40 border border-zinc-800 shadow-lg animate-pulse";
                div.innerHTML = `<img src="https://image.tmdb.org/t/p/w300${data.poster_path}" class="w-full h-full object-cover">`;
                grid.appendChild(div);
                div.classList.remove('animate-pulse');
            }

            card.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            card.style.transform = `translate(${liked ? 1200 : -1200}px, ${card.offsetTop}px) rotate(${liked ? 45 : -45}deg)`;
            
            setTimeout(() => {
                card.remove();
                totalCards--;
                if(totalCards === 0) {
                    document.getElementById('summary-screen').classList.remove('hidden');
                    document.getElementById('controls').classList.add('invisible');
                }
            }, 400);
        }

        function reset(c) {
            c.style.transform = '';
            c.querySelectorAll('.badge').forEach(b => b.style.opacity = 0);
        }

        function uiSwipe(L) {
            const cards = document.querySelectorAll('.card:not(#summary-screen)');
            if(cards.length > 0) {
                // We need the original data, so we find it in the DOM or state
                // For the UI button, we just trigger the swipe on the last card
                const topCard = cards[cards.length - 1];
                topCard.dispatchEvent(new CustomEvent('ui-swipe', {detail: L}));
                // Manually trigger for button since Hammer doesn't listen to buttons
                finalize(topCard, {id: Date.now()}, L); 
            }
        }

        async function shareList() {
            const names = watchlist.map(i => i.title || i.name).slice(0, 3).join(', ');
            const shareData = {
                title: 'My THR Watchlist',
                text: `I just built my 2026 watchlist on THR! My top picks: ${names}`,
                url: window.location.href
            };
            if (navigator.share) await navigator.share(shareData);
            else alert("Watchlist copied to clipboard!");
        }

        function resetHistory() {
            localStorage.removeItem('thr_seen_ids');
            location.reload();
        }

        init();
    </script>
</body>
</html>
